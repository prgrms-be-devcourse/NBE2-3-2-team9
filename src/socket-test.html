<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‚¬ìš©ì ìƒíƒœ WebSocket í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>

<h2>ğŸ”Œ ì‚¬ìš©ì ìƒíƒœ WebSocket í…ŒìŠ¤íŠ¸</h2>

<!-- ì—°ê²° ë° êµ¬ë… ë²„íŠ¼ -->
<button onclick="connect()">ğŸ”— ì—°ê²°í•˜ê¸°</button>
<button onclick="disconnect()">âŒ ì—°ê²° ëŠê¸°</button>

<div id="status">ìƒíƒœ: ì—°ê²°ë˜ì§€ ì•ŠìŒ</div>
<div id="user-status">ì‚¬ìš©ì ìƒíƒœ: ì—…ë°ì´íŠ¸ ì—†ìŒ</div>

<script>
    let stompClient = null;

    // âœ… ìƒˆë¡œ ë°œê¸‰ë°›ì€ JWT í† í°ì„ ì…ë ¥
    const jwtToken = "Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxIiwiaWF0IjoxNzM3MzA0Mjc2LCJleHAiOjE3MzczMDc4NzZ9.3xKjsxA1ScqexMm2itNBgLOp7VxfCZZ-xfDrLDGANkE";

    // WebSocket ì—°ê²°
    function connect() {
        const socket = new SockJS('http://localhost:8080/chat-socket');
        stompClient = Stomp.over(socket);

        stompClient.debug = console.log;

        // âœ… JWT í† í°ì„ Authorization í—¤ë”ì— ì¶”ê°€
        stompClient.connect(
            { Authorization: jwtToken },
            function (frame) {
                document.getElementById('status').innerText = 'ìƒíƒœ: ì—°ê²°ë¨ âœ…';
                console.log('Connected: ' + frame);

                // âœ… ì‚¬ìš©ì ìƒíƒœ êµ¬ë…
                const userId = "1"; // í…ŒìŠ¤íŠ¸í•  ì‚¬ìš©ì ID
                stompClient.subscribe(`/topic/user-status/${userId}`, function (message) {
                    console.log("Subscribed successfully to: ", `/topic/user-status/${userId}`);
                    console.log("Raw message: ", message);
                    console.log("Message body: ", message.body);
                    updateUserStatus(userId, message.body);
                });
            },
            function (error) {
                document.getElementById('status').innerText = 'ìƒíƒœ: ì—°ê²° ì‹¤íŒ¨ âŒ';
                console.error('ì—°ê²° ì‹¤íŒ¨:', error);
            }
        );
    }

    // ì—°ê²° ëŠê¸°
    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect(() => {
                document.getElementById('status').innerText = 'ìƒíƒœ: ì—°ê²° í•´ì œë¨ â';
                console.log("Disconnected");
            });
        }
    }

    // ì‚¬ìš©ì ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateUserStatus(userId, status) {
        const statusDiv = document.getElementById('user-status');
        statusDiv.innerText = `ì‚¬ìš©ì ìƒíƒœ: ${userId} â†’ ${status}`;
        console.log(`ì‚¬ìš©ì ìƒíƒœ ì—…ë°ì´íŠ¸: ${userId} â†’ ${status}`);
    }
</script>

</body>
</html>
