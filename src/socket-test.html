<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ… ë° WebSocket í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        h1, h2 {
            text-align: center;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .chat-box, .room-list {
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .chat-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .chat-input input, .chat-input button {
            padding: 10px;
        }
        .chat-input input {
            flex: 1;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .chat-input button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .chat-input button:hover {
            background-color: #0056b3;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
            border-radius: 10px;
            max-width: 60%;
            word-wrap: break-word;
        }

        .sent {
            background-color: #e0f7fa;
            align-self: flex-end;
            text-align: right;
        }

        .received {
            background-color: #f1f1f1;
            align-self: flex-start;
            text-align: left;
        }

        .chat-box {
            display: flex;
            flex-direction: column;
            padding: 10px;
            overflow-y: auto;
            height: 300px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ì±„íŒ… ë° WebSocket í…ŒìŠ¤íŠ¸</h1>

    <!-- WebSocket ì—°ê²° ìƒíƒœ í™•ì¸ -->
    <section id="connection-section">
        <h2>WebSocket ì—°ê²° ìƒíƒœ í™•ì¸</h2>
        <button onclick="connect()">ğŸ”— ì—°ê²°í•˜ê¸°</button>
        <button onclick="disconnect()">âŒ ì—°ê²° ëŠê¸°</button>
        <div id="status">ìƒíƒœ: ì—°ê²°ë˜ì§€ ì•ŠìŒ</div>
        <div id="user-status">ì‚¬ìš©ì ìƒíƒœ: ì—…ë°ì´íŠ¸ ì—†ìŒ</div>
    </section>

    <!-- ì±„íŒ… ë°© ëª©ë¡ ë° ì±„íŒ… ê¸°ëŠ¥ -->
    <section id="room-section">
        <h2>Chat Rooms</h2>
        <div class="chat-input">
            <input id="username" type="text" placeholder="Enter your username" />
        </div>
        <div class="chat-input">
            <input id="keyword" type="text" placeholder="Search chat rooms..." />
            <button onclick="searchRooms()">Search</button>
            <button onclick="fetchChatRooms()">Refresh</button>
        </div>
        <div class="room-list" id="room-list"></div>
        <div class="chat-input">
            <input id="new-room-name" type="text" placeholder="New room name..." />
            <input id="new-room-desc" type="text" placeholder="Room description..." />
            <button onclick="createRoom()">Create Room</button>
        </div>
    </section>

    <section id="chat-section" style="display: none;">
        <h2>Chat Room: <span id="current-room-name"></span></h2>
        <div class="chat-box" id="chat-box"></div>
        <div class="chat-input">
            <input id="new-message" type="text" placeholder="Type your message..." />
            <button onclick="sendMessage()">Send</button>
            <button onclick="exitRoom()">Exit Room</button>
        </div>
        <button onclick="backToRooms()">Back to Room List</button>
    </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    // WebSocket ë° ì±„íŒ… ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì´ì „ ì½”ë“œì—ì„œ í†µí•©
    const apiUrl = "http://localhost:8080/api/user/chat";
    let stompClient = null;
    let currentRoomId = null;
    let isSubscribed = false;

    const jwtToken = "Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIzIiwiaWF0IjoxNzM3MzQxNDU3LCJleHAiOjE3MzczNDUwNTd9.UZklbbUXASY38ze_XcTvW9xDu-YnFaY8NTUWxGKhWTM";

    function connect() {
        const socket = new SockJS('http://localhost:8080/chat-socket');
        stompClient = Stomp.over(socket);

        stompClient.connect(
            { Authorization: jwtToken },
            function (frame) {
                document.getElementById('status').innerText = 'ìƒíƒœ: ì—°ê²°ë¨ âœ…';
                console.log('Connected: ' + frame);

                const userId = "1";
                stompClient.subscribe(`/topic/user-status/${userId}`, function (message) {
                    updateUserStatus(userId, message.body);
                });
            },
            function (error) {
                document.getElementById('status').innerText = 'ìƒíƒœ: ì—°ê²° ì‹¤íŒ¨ âŒ';
                console.error('ì—°ê²° ì‹¤íŒ¨:', error);
            }
        );
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect(() => {
                document.getElementById('status').innerText = 'ìƒíƒœ: ì—°ê²° í•´ì œë¨ â';
                console.log("Disconnected");
            });
        }
    }

    function updateUserStatus(userId, status) {
        const statusDiv = document.getElementById('user-status');
        statusDiv.innerText = `ì‚¬ìš©ì ìƒíƒœ: ${userId} â†’ ${status}`;
        console.log(`ì‚¬ìš©ì ìƒíƒœ ì—…ë°ì´íŠ¸: ${userId} â†’ ${status}`);
    }


    // Fetch chat rooms
    async function fetchChatRooms() {
        try {
            const response = await fetch(`${apiUrl}/rooms`);
            const rooms = await response.json();
            const roomList = document.getElementById("room-list");
            roomList.innerHTML = rooms.map(room => `
                <div>
                    <strong>${room.roomName}</strong> - ${room.description}
                    <button onclick="enterRoom('${room.roomId}', '${room.roomName}')">Enter</button>
                </div>
            `).join("");
        } catch (error) {
            console.error("Error fetching chat rooms:", error);
        }
    }



    // Search chat rooms
    async function searchRooms() {
        const keyword = document.getElementById("keyword").value.trim();

        if (!keyword) {
            fetchChatRooms();
            return;
        }

        try {
            const response = await fetch(`${apiUrl}/rooms/search?keyword=${encodeURIComponent(keyword)}`, {
                method: "GET",
                headers: {
                    "Authorization": jwtToken,
                    "Content-Type": "application/json"
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            console.log("Rooms Response:", result);

            const roomList = document.getElementById("room-list");

            // ì¤‘ì²©ëœ data í•„ë“œë¡œ ì ‘ê·¼
            if (result.data && Array.isArray(result.data.data)) {
                roomList.innerHTML = result.data.data.map(room => `
            <div>
                <strong>${room.roomName}</strong> - ${room.description}
                <button onclick="enterRoom('${room.roomId}', '${room.roomName}')">Enter</button>
            </div>
        `).join("");

                // meta ì •ë³´ ë¡œê·¸ë¡œ í™•ì¸
                console.log("Pagination Info:", result.data.meta);
            } else {
                throw new Error("Unexpected response format.");
            }
        } catch (error) {
            console.error("Error searching chat rooms:", error);
            alert("Error searching chat rooms: " + error.message);
        }
    }



    // Create a new room
    // ì±„íŒ…ë°© ìƒì„±
    async function createRoom() {
        const roomName = document.getElementById("new-room-name").value.trim();
        const description = document.getElementById("new-room-desc").value.trim();

        if (!roomName) {
            alert("ì±„íŒ…ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!");
            return;
        }

        try {
            console.log("Sending JWT token:", jwtToken); // JWT í™•ì¸ ë¡œê·¸
            const response = await fetch(`${apiUrl}/rooms`, {
                method: "POST",
                headers: {
                    "Authorization": `${jwtToken}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    roomName: roomName,
                    description: description
                })
            });

            if (response.ok) {
                alert("ì±„íŒ…ë°©ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!");
                fetchChatRooms(); // ëª©ë¡ ê°±ì‹ 
            } else {
                const errorData = await response.json();
                alert(`ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨: ${JSON.stringify(errorData)}`);
            }
        } catch (error) {
            console.error("ì±„íŒ…ë°© ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            alert("ì±„íŒ…ë°© ìƒì„± ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.");
        }
    }


    // Enter a chat room
    async function enterRoom(roomId, roomName) {
        currentRoomId = roomId; // ì„ íƒí•œ ë°© ID ì €ì¥
        document.getElementById("current-room-name").textContent = roomName;
        document.getElementById("room-section").style.display = "none"; // ë°© ë¦¬ìŠ¤íŠ¸ ìˆ¨ê¹€
        document.getElementById("chat-section").style.display = "block"; // ì±„íŒ… í™”ë©´ í‘œì‹œ

        connect(); // WebSocket ì—°ê²° ì‹œì‘
        fetchChatLogs(); // ê¸°ì¡´ ì±„íŒ… ê¸°ë¡ ë¡œë“œ
    }

    // Fetch chat logs
    async function fetchChatLogs() {
        try {
            const response = await fetch(`${apiUrl}/rooms/${currentRoomId}/logs`);
            const data = await response.json();

            const messages = Array.isArray(data) ? data : data.messages || [];
            messages.forEach(msg => updateChatBox({
                sender: msg.sender,
                content: msg.content,
                timestamp: msg.timestamp
            }));
        } catch (error) {
            console.error("Error fetching chat logs:", error);
        }

    }

    // Send a message
    function sendMessage() {
        const content = document.getElementById("new-message").value.trim();
        const username = document.getElementById("username").value.trim(); // ì‚¬ìš©ì ì´ë¦„ì„ ë™ì ìœ¼ë¡œ ê°€ì ¸ì˜´

        if (!content || !currentRoomId || !username) return;

        if (!stompClient || !stompClient.connected) {
            alert("WebSocket is not connected.");
            console.error("stompClient is not connected.");
            return;
        }

        const message = {
            sender:  username,
            roomId: currentRoomId,
            content,
            timestamp: new Date().toLocaleString(), // í˜„ì¬ ì‹œê°„ ì¶”ê°€
            type: "TALK"
        };

        stompClient.send(`/app/chat/${currentRoomId}`, {}, JSON.stringify(message));
        console.log("Message sent:", message);

        document.getElementById("new-message").value = "";
    }

    function exitRoom() {
        currentRoomId = null;
        if (stompClient) {
            stompClient.disconnect();
            stompClient = null;
        }
        document.getElementById("room-section").style.display = "block";
        document.getElementById("chat-section").style.display = "none";
    }

    // Back to room list
    function backToRooms() {
        currentRoomId = null;
        document.getElementById("room-section").style.display = "block";
        document.getElementById("chat-section").style.display = "none";
        fetchChatRooms();
    }

    fetchChatRooms(); // ì´ˆê¸° ë¡œë“œ ì‹œ ë°© ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
</script>
</body>
</html>
